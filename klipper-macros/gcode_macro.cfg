# K1C
# CreateDate: 2023/09/05

[gcode_macro PRINTER_PARAM]
variable_z_safe_pause: 0.0
variable_z_safe_g28: 3.0
variable_max_x_position: 220.0
variable_max_y_position: 220.0
variable_max_z_position: 250.0
variable_fans: 3
variable_auto_g29: 0
variable_fan0_min: 25
variable_fan1_min: 50
variable_fan2_min: 180
variable_fan2_speed: 0
variable_hotend_temp: 0
variable_e_min_current: 0.27
variable_cam_off_temp: 60
variable_post_cool_level: 25
gcode:

[gcode_macro AUTOTUNE_SHAPERS]
variable_autotune_shapers: 'ei'
gcode:

[gcode_macro LOAD_MATERIAL_CLOSE_FAN2]
variable_fan2_value: 0
gcode:
  M118 ========================================
  M118 [LOAD_MATERIAL_CLOSE_FAN2] Saving state and closing fan2
  M118 ========================================
  M118 [LOAD_MATERIAL_CLOSE_FAN2] Step 1/3: Saving gcode state
  SAVE_GCODE_STATE NAME=myMoveState
  {% if printer['output_pin fan2'].value > 0.0 %}
    M118 [LOAD_MATERIAL_CLOSE_FAN2] Step 2/3: Fan2 active, saving value and turning off
    SET_GCODE_VARIABLE MACRO=LOAD_MATERIAL_CLOSE_FAN2 VARIABLE=fan2_value VALUE={printer['output_pin fan2'].value}
    M107 P2
  {% else %}
    M118 [LOAD_MATERIAL_CLOSE_FAN2] Step 2/3: Fan2 not active, skipping
  {% endif %}
  M118 [LOAD_MATERIAL_CLOSE_FAN2] Step 3/3: Restoring extruder current
  RESTORE_E_CURRENT
  M118 ========================================
  M118 [LOAD_MATERIAL_CLOSE_FAN2] MACRO END
  M118 ========================================

[gcode_macro LOAD_MATERIAL_RESTORE_FAN2]
gcode:
  M118 ========================================
  M118 [LOAD_MATERIAL_RESTORE_FAN2] Restoring state and fan2
  M118 ========================================
  {% set fan2_value = printer['gcode_macro LOAD_MATERIAL_CLOSE_FAN2'].fan2_value|float %}
  M118 [LOAD_MATERIAL_RESTORE_FAN2] Step 1/3: Restoring gcode state
  RESTORE_GCODE_STATE NAME=myMoveState
  {% if fan2_value > 0.0 %}
    M118 [LOAD_MATERIAL_RESTORE_FAN2] Step 2/3: Restoring fan2 value={fan2_value}
    {% set s_value = (fan2_value * 255 - printer["gcode_macro PRINTER_PARAM"].fan2_min) * 255 / (255 - printer["gcode_macro PRINTER_PARAM"].fan2_min) %}
    M106 P2 S{s_value}
    SET_GCODE_VARIABLE MACRO=LOAD_MATERIAL_CLOSE_FAN2 VARIABLE=fan2_value VALUE=0
  {% else %}
    M118 [LOAD_MATERIAL_RESTORE_FAN2] Step 2/3: No fan2 value to restore
  {% endif %}
  M118 [LOAD_MATERIAL_RESTORE_FAN2] Step 3/3: Setting minimum extruder current
  SET_E_MIN_CURRENT
  M118 ========================================
  M118 [LOAD_MATERIAL_RESTORE_FAN2] MACRO END
  M118 ========================================

[gcode_macro SET_E_MIN_CURRENT]
gcode:
  M118 ========================================
  M118 [SET_E_MIN_CURRENT] Setting extruder to minimum current
  M118 ========================================
  {% set e_current = printer['gcode_macro PRINTER_PARAM'].e_min_current %}
  M118 [SET_E_MIN_CURRENT] Step 1/3: Waiting for moves to complete
  M400
  M118 [SET_E_MIN_CURRENT] Step 2/3: Setting current to {e_current}A
  SET_TMC_CURRENT STEPPER=extruder CURRENT={e_current} HOLDCURRENT={e_current}
  M118 [SET_E_MIN_CURRENT] Step 3/3: Waiting 2 seconds for current change
  G4 P2000
  M118 ========================================
  M118 [SET_E_MIN_CURRENT] MACRO END
  M118 ========================================

[gcode_macro RESTORE_E_CURRENT]
gcode:
  M118 ========================================
  M118 [RESTORE_E_CURRENT] Restoring extruder to normal current
  M118 ========================================
  {% set e_current = printer.configfile.settings['tmc2209 extruder'].run_current %}
  M118 [RESTORE_E_CURRENT] Step 1/3: Waiting for moves to complete
  M400
  M118 [RESTORE_E_CURRENT] Step 2/3: Restoring current to {e_current}A
  SET_TMC_CURRENT STEPPER=extruder CURRENT={e_current} HOLDCURRENT={e_current}
  M118 [RESTORE_E_CURRENT] Step 3/3: Waiting 2 seconds for current change
  G4 P2000
  M118 ========================================
  M118 [RESTORE_E_CURRENT] MACRO END
  M118 ========================================

[gcode_macro LOAD_MATERIAL]
gcode:
  M118 ========================================
  M118 [LOAD_MATERIAL] Loading filament
  M118 ========================================
  M118 [LOAD_MATERIAL] Step 1/5: Closing fan2 and saving state
  LOAD_MATERIAL_CLOSE_FAN2
  M118 [LOAD_MATERIAL] Step 2/5: Heating to {printer.custom_macro.default_extruder_temp}C
  M109 S{printer.custom_macro.default_extruder_temp}
  M118 [LOAD_MATERIAL] Step 3/5: Switching to relative positioning
  G91
  M118 [LOAD_MATERIAL] Step 4/5: Extruding 80mm at 180mm/min
  G1 E80 F180
  M118 [LOAD_MATERIAL] Step 5/5: Restoring fan2 and state
  LOAD_MATERIAL_RESTORE_FAN2
  M118 ========================================
  M118 [LOAD_MATERIAL] MACRO END
  M118 ========================================

[gcode_macro QUIT_MATERIAL]
gcode:
  M118 ========================================
  M118 [QUIT_MATERIAL] Unloading filament
  M118 ========================================
  M118 [QUIT_MATERIAL] Step 1/6: Saving gcode state
  SAVE_GCODE_STATE NAME=myMoveState
  M118 [QUIT_MATERIAL] Step 2/6: Restoring extruder current
  RESTORE_E_CURRENT
  M118 [QUIT_MATERIAL] Step 3/6: Heating to {printer.custom_macro.default_extruder_temp}C
  M109 S{printer.custom_macro.default_extruder_temp}
  M118 [QUIT_MATERIAL] Step 4/6: Switching to relative extrusion
  M83
  M118 [QUIT_MATERIAL] Step 5/6: Performing unload sequence
  G1 E100 F300
  G1 E-15 F3000
  G1 E-22.4700 F2400
  G1 E-6.4200 F1200
  G1 E-3.2100 F720
  G1 E5.0000 F356
  G1 E-5.0000 F384
  G1 E5.0000 F412
  G1 E-5.0000 F440
  G1 E5.0000 F467
  G1 E-5.0000 F495
  G1 E5.0000 F523
  G1 E-5.0000 F3000
  G1 E-15 F3000
  M118 [QUIT_MATERIAL] Step 6/6: Setting minimum current and restoring state
  SET_E_MIN_CURRENT
  RESTORE_GCODE_STATE NAME=myMoveState
  M118 ========================================
  M118 [QUIT_MATERIAL] MACRO END
  M118 ========================================


[gcode_macro Qmode]
variable_flag: 0
variable_accel: 0
variable_accel_to_decel: 0
variable_velocity: 0
variable_square_corner_velocity: 0
variable_pressure_advance:0.0
variable_fan0_value: 0.00
variable_fan1_value: 0.00
variable_fan2_value: 0.00
variable_speed_factor: 0
variable_max_accel: 2500
variable_max_accel_to_decel: 2500
gcode:
  {% set printer_state = printer.print_stats.state %}
  {% if printer['gcode_macro Qmode'].flag|int == 0 %}
    {% if printer_state == "printing" or printer_state == "paused" %}
      SET_GCODE_VARIABLE MACRO=Qmode VARIABLE=accel VALUE={printer.toolhead.max_accel}
      SET_GCODE_VARIABLE MACRO=Qmode VARIABLE=accel_to_decel VALUE={printer.toolhead.max_accel_to_decel}
      SET_GCODE_VARIABLE MACRO=Qmode VARIABLE=velocity VALUE={printer.toolhead.max_velocity}
      SET_GCODE_VARIABLE MACRO=Qmode VARIABLE=square_corner_velocity VALUE={printer.toolhead.square_corner_velocity}
      SET_GCODE_VARIABLE MACRO=Qmode VARIABLE=pressure_advance VALUE={printer.extruder.pressure_advance}
      SET_GCODE_VARIABLE MACRO=Qmode VARIABLE=speed_factor VALUE={printer.gcode_move.speed_factor}
      SET_GCODE_VARIABLE MACRO=Qmode VARIABLE=fan0_value VALUE={printer['output_pin fan0'].value}
      SET_GCODE_VARIABLE MACRO=Qmode VARIABLE=fan1_value VALUE={printer['output_pin fan1'].value}
      SET_GCODE_VARIABLE MACRO=Qmode VARIABLE=fan2_value VALUE={printer['output_pin fan2'].value}
      SET_TMC_FIELD STEPPER=stepper_x FIELD=en_spreadcycle VALUE=0
      SET_TMC_FIELD STEPPER=stepper_y FIELD=en_spreadcycle VALUE=0

      SET_TMC_CURRENT STEPPER=stepper_x CURRENT=1.0 
      SET_TMC_CURRENT STEPPER=stepper_y CURRENT=1.0 
      G4 P1000

      # Set Motion Parameters
      SET_VELOCITY_LIMIT ACCEL=2500
      SET_VELOCITY_LIMIT ACCEL_TO_DECEL=2500
      SET_VELOCITY_LIMIT VELOCITY=150
      SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY=5
      SET_PRESSURE_ADVANCE ADVANCE=0.05
      M220 S50

      {% set tmp = printer['output_pin fan0'].value * 255 %}
      SET_GCODE_VARIABLE MACRO=Qmode VARIABLE=fan0_value VALUE={tmp}
      {% if tmp - printer['gcode_macro PRINTER_PARAM'].fan0_min > (255 - printer['gcode_macro PRINTER_PARAM'].fan0_min) / 2 %}
        {% set tmp = printer['gcode_macro PRINTER_PARAM'].fan0_min + (255 - printer['gcode_macro PRINTER_PARAM'].fan0_min) / 2 %}
        SET_PIN PIN=fan0 VALUE={tmp}
      {% endif %}

      {% set tmp = printer['output_pin fan1'].value * 255 %}
      SET_GCODE_VARIABLE MACRO=Qmode VARIABLE=fan1_value VALUE={printer['output_pin fan1'].value * 255}
      {% if tmp - printer['gcode_macro PRINTER_PARAM'].fan1_min > (255 - printer['gcode_macro PRINTER_PARAM'].fan1_min) / 2 %}
        {% set tmp = printer['gcode_macro PRINTER_PARAM'].fan1_min + (255 - printer['gcode_macro PRINTER_PARAM'].fan1_min) / 2 %}
        SET_PIN PIN=fan1 VALUE={tmp}
      {% endif %}

      {% set tmp = printer['output_pin fan2'].value * 255 %}
      SET_GCODE_VARIABLE MACRO=Qmode VARIABLE=fan2_value VALUE={printer['output_pin fan2'].value * 255}
      {% if tmp - printer['gcode_macro PRINTER_PARAM'].fan2_min > (255 - printer['gcode_macro PRINTER_PARAM'].fan2_min) / 2 %}
        {% set tmp = printer['gcode_macro PRINTER_PARAM'].fan2_min + (255 - printer['gcode_macro PRINTER_PARAM'].fan2_min) / 2 %}
        SET_PIN PIN=fan2 VALUE={tmp}
      {% endif %}

      SET_GCODE_VARIABLE MACRO=Qmode VARIABLE=flag VALUE=1
      SET_QMODE_FLAG FLAG=1
    {% endif %}
  {% endif %}

[gcode_macro Qmode_exit]
gcode:
  {% set printer_state = printer.print_stats.state %}
  {% if printer['gcode_macro Qmode'].flag|int == 1 %}
    {% if printer_state == "printing" or printer_state == "paused" %}
      SET_VELOCITY_LIMIT ACCEL={printer['gcode_macro Qmode'].accel}
      SET_VELOCITY_LIMIT ACCEL_TO_DECEL={printer['gcode_macro Qmode'].accel_to_decel}
      SET_VELOCITY_LIMIT VELOCITY={printer['gcode_macro Qmode'].velocity}
      SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={printer['gcode_macro Qmode'].square_corner_velocity}
      SET_PRESSURE_ADVANCE ADVANCE={printer['gcode_macro Qmode'].pressure_advance}
      M220 S{printer['gcode_macro Qmode'].speed_factor * 100}
      
      {% set X_RUN_CUR = printer.configfile.settings['tmc2209 stepper_x'].run_current %}
      {% set Y_RUN_CUR = printer.configfile.settings['tmc2209 stepper_y'].run_current %}
      SET_TMC_CURRENT STEPPER=stepper_x CURRENT={X_RUN_CUR}
      SET_TMC_CURRENT STEPPER=stepper_y CURRENT={Y_RUN_CUR}

      SET_TMC_FIELD STEPPER=stepper_x FIELD=en_spreadcycle VALUE=1
      SET_TMC_FIELD STEPPER=stepper_y FIELD=en_spreadcycle VALUE=1 
      G4 P1000

      SET_GCODE_VARIABLE MACRO=Qmode VARIABLE=flag VALUE=0
      SET_QMODE_FLAG FLAG=0

      {% if printer['output_pin fan0'].value != 0 %}
        {action_respond_info("fan0_value = %s" % printer['gcode_macro Qmode'].fan0_value)}
        SET_PIN PIN=fan0 VALUE={printer['gcode_macro Qmode'].fan0_value}
        SET_GCODE_VARIABLE MACRO=Qmode VARIABLE=fan0_value VALUE=0
      {% endif %}
      {% if printer['output_pin fan1'].value != 0 %}
        {action_respond_info("fan1_value = %s" % printer['gcode_macro Qmode'].fan1_value)}
        SET_PIN PIN=fan1 VALUE={printer['gcode_macro Qmode'].fan1_value}
        SET_GCODE_VARIABLE MACRO=Qmode VARIABLE=fan1_value VALUE=0
      {% endif %}
      {% if printer['output_pin fan2'].value != 0 %}
        {action_respond_info("fan2_value = %s" % printer['gcode_macro Qmode'].fan2_value)}
        SET_PIN PIN=fan2 VALUE={printer['gcode_macro Qmode'].fan2_value}
        SET_GCODE_VARIABLE MACRO=Qmode VARIABLE=fan2_value VALUE=0
      {% endif %}
    {% endif %}
  {% endif %}

[gcode_macro M204]
rename_existing: M204.1
gcode:
  # {% if printer['gcode_macro Qmode'].flag|int == 0 %}
    {% set get_params = "" %}
    {% set qmode_max_accel = printer['gcode_macro Qmode'].max_accel|string %}
    {% if 'S' in params|upper %}
      {% if printer['gcode_macro Qmode'].flag|int == 1 and params.S|float > qmode_max_accel|float %}
        {% set get_params = (get_params + ' ' + 'S' + qmode_max_accel) %}
      {% else %}
        {% set get_params = (get_params + ' ' + 'S' + params.S) %}
      {% endif %}
    {% endif %}
    {% if 'P' in params|upper %}
      {% if printer['gcode_macro Qmode'].flag|int == 1 and params.P|float > qmode_max_accel|float %}
        {% set get_params = (get_params + ' ' + 'P' + qmode_max_accel) %}
      {% else %}
        {% set get_params = (get_params + ' ' + 'P' + params.P) %}
      {% endif %}
    {% endif %}
    {% if 'T' in params|upper %}
      {% if printer['gcode_macro Qmode'].flag|int == 1 and params.T|float > qmode_max_accel|float %}
        {% set get_params = (get_params + ' ' + 'T' + qmode_max_accel) %}
      {% else %}
        {% set get_params = (get_params + ' ' + 'T' + params.T) %}
      {% endif %}
    {% endif %}
    M204.1 {get_params}
[gcode_macro M205]
gcode:
  {% if 'X' in params %}
    SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={params.X}
  {% elif 'Y' in params %}
    SET_VELOCITY_LIMIT SQUARE_CORNER_VELOCITY={params.Y}
  {% endif %}

[gcode_macro M106]
gcode:
  {% set fans = printer["gcode_macro PRINTER_PARAM"].fans|int %}
  {% set fan = 0 %}
  {% set value = 0 %}
  {% if params.P is defined %}
    {% set tmp = params.P|int %}
    {% if tmp < fans %}
      {% set fan = tmp %}
    {% endif %}
  {% endif %}
  {% if params.S is defined %}
    {% set tmp = params.S|float %}
  {% else %}
    {% set tmp = 255 %}
  {% endif %}
  {% if tmp > 0 %}
    {% if fan == 0 %}
      {% set value = (255 - printer["gcode_macro PRINTER_PARAM"].fan0_min) / 255 * tmp %}
      {% if printer['gcode_macro Qmode'].flag | int == 1 %}
        SET_GCODE_VARIABLE MACRO=Qmode VARIABLE=fan0_value VALUE={printer["gcode_macro PRINTER_PARAM"].fan0_min + value}
        {% if value > (255 - printer['gcode_macro PRINTER_PARAM'].fan0_min) / 2  %}
          {% set value = printer["gcode_macro PRINTER_PARAM"].fan0_min + (255 - printer['gcode_macro PRINTER_PARAM'].fan0_min) / 2 %}
        {% else %}
          {% set value = printer["gcode_macro PRINTER_PARAM"].fan0_min + value %}
        {% endif %}
      {% else %}
        {% set value = printer["gcode_macro PRINTER_PARAM"].fan0_min + value %}
      {% endif %}
    {% endif %}
    {% if fan == 1 %}
      {% set value = (255 - printer["gcode_macro PRINTER_PARAM"].fan1_min) / 255 * tmp %}
      {% if printer['gcode_macro Qmode'].flag | int == 1 %}
        SET_GCODE_VARIABLE MACRO=Qmode VARIABLE=fan1_value VALUE={printer["gcode_macro PRINTER_PARAM"].fan1_min + value}
        {% if value > (255 - printer['gcode_macro PRINTER_PARAM'].fan1_min) / 2  %}
          {% set value = printer["gcode_macro PRINTER_PARAM"].fan1_min + (255 - printer['gcode_macro PRINTER_PARAM'].fan1_min) / 2 %}
        {% else %}
          {% set value = printer["gcode_macro PRINTER_PARAM"].fan1_min + value %}
        {% endif %}
      {% else %}
        {% set value = printer["gcode_macro PRINTER_PARAM"].fan1_min + value %}
      {% endif %}
    {% endif %}
    {% if fan == 2 %}
      {% set value = (255 - printer["gcode_macro PRINTER_PARAM"].fan2_min) / 255 * tmp %}
      {% if printer['gcode_macro Qmode'].flag | int == 1 %}
        SET_GCODE_VARIABLE MACRO=Qmode VARIABLE=fan2_value VALUE={printer["gcode_macro PRINTER_PARAM"].fan2_min + value}
        {% if value > (255 - printer['gcode_macro PRINTER_PARAM'].fan2_min) / 2  %}
          {% set value = printer["gcode_macro PRINTER_PARAM"].fan2_min + (255 - printer['gcode_macro PRINTER_PARAM'].fan2_min) / 2 %}
        {% else %}
          {% set value = printer["gcode_macro PRINTER_PARAM"].fan2_min + value %}
        {% endif %}
      {% else %}
        {% set value = printer["gcode_macro PRINTER_PARAM"].fan2_min + value %}
      {% endif %}
    {% endif %}
  {% endif %}
  {% if value >= 255 %}
    {% set value = 255 %}
  {% endif %}
  SET_PIN PIN=fan{fan} VALUE={value}

[gcode_macro M107]
gcode:
  {% set fans = printer["gcode_macro PRINTER_PARAM"].fans|int %}
  {% if params.P is defined %}
    {% if params.P|int < fans %}
      SET_PIN PIN=fan{params.P|int} VALUE=0
    {% else %}
      SET_PIN PIN=fan0 VALUE=0
    {% endif %}
  {% else %}
    SET_PIN PIN=fan0 VALUE=0
    SET_PIN PIN=fan2 VALUE=0
  {% endif %}

[gcode_macro M141]
description: Set Chamber temperature with slicers
gcode:
  {% if 'S' in params|upper %}
    {% if printer["temperature_fan chamber_fan"].speed > 0.0 %}
      SET_PIN PIN=fan1 VALUE=255
    {% else %}
      SET_PIN PIN=fan1 VALUE=0
    {% endif %}
    {% if params.S|int > 0 %}
      SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=chamber_fan TARGET={params.S|default(35)}
    {% else %}
      SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=chamber_fan TARGET=35
      {% if params.S|int == 0 %}
        SET_PIN PIN=fan1 VALUE=0
      {% endif %}
    {% endif %}
  {% endif %}

[gcode_macro M900]
gcode:
  {% if 'K' in params %}
    {% if 'E' in params %}
      SET_PRESSURE_ADVANCE EXTRUDER={params.E} ADVANCE={params.K}
    {% else %}
      SET_PRESSURE_ADVANCE ADVANCE={params.K}
    {% endif %}
  {% endif %}

[delayed_gcode wait_temp]
# initial_duration: 2.
gcode:
  {% set cur_temp = printer.extruder.temperature %}
  {% if cur_temp|int < 40 %}
    WAIT_TEMP_END
  {% else %}
    UPDATE_DELAYED_GCODE ID=wait_temp DURATION=5
  {% endif %}

[gcode_macro WAIT_TEMP_START]
gcode:
  M118 ========================================
  M118 [WAIT_TEMP_START] Starting temperature wait
  M118 ========================================
  M118 [WAIT_TEMP_START] Step 1/2: Starting delayed gcode timer
  UPDATE_DELAYED_GCODE ID=wait_temp DURATION=1
  M118 [WAIT_TEMP_START] Step 2/2: Turning on part cooling fan
  M106 P0 S255
  # M106 P2 S255
  M118 ========================================
  M118 [WAIT_TEMP_START] MACRO END
  M118 ========================================

[gcode_macro WAIT_TEMP_END]
gcode:
  M118 ========================================
  M118 [WAIT_TEMP_END] Ending temperature wait
  M118 ========================================
  M118 [WAIT_TEMP_END] Step 1/2: Stopping delayed gcode timer
  UPDATE_DELAYED_GCODE ID=wait_temp DURATION=0
  M118 [WAIT_TEMP_END] Step 2/2: Turning off part cooling fan
  M106 P0 S0
  # M106 P2 S0
  M118 ========================================
  M118 [WAIT_TEMP_END] MACRO END
  M118 ========================================

# Post-Print Cooling Macros
# Call these from your slicer's filament-specific end gcode
# They will automatically shut off when hotend drops below 40Â°C

[gcode_macro POST_COOL_100]
description: Post-print cooling at 100% fan speed (aggressive - ideal for PLA)
gcode:
  M118 ========================================
  M118 [POST_COOL_100] Starting 100% post-print cooling
  M118 ========================================
  M118 [POST_COOL_100] Fan speed: 100% (255/255) - All fans
  M118 [POST_COOL_100] Will auto-stop at 40C
  UPDATE_DELAYED_GCODE ID=wait_temp DURATION=1
  M106 P0 S255  ; Model cooling fan
  M106 P1 S255  ; Chamber/Side fan
  M106 P2 S255  ; Auxiliary/Case fan
  M118 ========================================
  M118 [POST_COOL_100] MACRO END
  M118 ========================================

[gcode_macro POST_COOL_75]
description: Post-print cooling at 75% fan speed (moderate-high - ideal for PLA/PETG)
gcode:
  M118 ========================================
  M118 [POST_COOL_75] Starting 75% post-print cooling
  M118 ========================================
  M118 [POST_COOL_75] Fan speed: 75% (191/255) - All fans
  M118 [POST_COOL_75] Will auto-stop at 40C
  UPDATE_DELAYED_GCODE ID=wait_temp DURATION=1
  M106 P0 S191  ; Model cooling fan
  M106 P1 S191  ; Chamber/Side fan
  M106 P2 S191  ; Auxiliary/Case fan
  M118 ========================================
  M118 [POST_COOL_75] MACRO END
  M118 ========================================

[gcode_macro POST_COOL_50]
description: Post-print cooling at 50% fan speed (moderate - ideal for PETG)
gcode:
  M118 ========================================
  M118 [POST_COOL_50] Starting 50% post-print cooling
  M118 ========================================
  M118 [POST_COOL_50] Fan speed: 50% (128/255) - All fans
  M118 [POST_COOL_50] Will auto-stop at 40C
  UPDATE_DELAYED_GCODE ID=wait_temp DURATION=1
  M106 P0 S128  ; Model cooling fan
  M106 P1 S128  ; Chamber/Side fan
  M106 P2 S128  ; Auxiliary/Case fan
  M118 ========================================
  M118 [POST_COOL_50] MACRO END
  M118 ========================================

[gcode_macro POST_COOL_25]
description: Post-print cooling at 25% fan speed (gentle - ideal for ABS/ASA)
gcode:
  M118 ========================================
  M118 [POST_COOL_25] Starting 25% post-print cooling
  M118 ========================================
  M118 [POST_COOL_25] Fan speed: 25% (64/255) - All fans
  M118 [POST_COOL_25] Will auto-stop at 40C
  UPDATE_DELAYED_GCODE ID=wait_temp DURATION=1
  M106 P0 S64   ; Model cooling fan
  M106 P1 S64   ; Chamber/Side fan
  M106 P2 S64   ; Auxiliary/Case fan
  M118 ========================================
  M118 [POST_COOL_25] MACRO END
  M118 ========================================

[gcode_macro POST_COOL_NONE]
description: No post-print cooling (for materials that warp with cooling)
gcode:
  M118 ========================================
  M118 [POST_COOL_NONE] Disabling post-print cooling
  M118 ========================================
  M118 [POST_COOL_NONE] Stopping any active cooling timers
  UPDATE_DELAYED_GCODE ID=wait_temp DURATION=0
  M118 [POST_COOL_NONE] Turning off all fans
  M106 P0 S0  ; Model cooling fan
  M106 P1 S0  ; Chamber/Side fan
  M106 P2 S0  ; Auxiliary/Case fan
  M118 [POST_COOL_NONE] Natural cooldown only
  M118 ========================================
  M118 [POST_COOL_NONE] MACRO END
  M118 ========================================

[gcode_macro PRINT_CALIBRATION]
# This part of the command is replaced by the application side without passing parameters
gcode:
  CX_PRINT_LEVELING_CALIBRATION

[gcode_macro FIRST_FLOOR_PAUSE_POSITION]
gcode:
  M118 ========================================
  M118 [FIRST_FLOOR_PAUSE_POSITION] Moving to first floor pause position
  M118 ========================================
  {% set extruder_temp = printer.custom_macro.g28_ext_temp %}
  {% set y_park = printer.toolhead.axis_maximum.y/2 %}
  {% set x_park = printer['gcode_macro PRINTER_PARAM'].max_x_position|float + 1 %}
  M118 [FIRST_FLOOR_PAUSE_POSITION] Step 1/4: Setting extruder temp to {extruder_temp}C
  M104 S{extruder_temp}
  M118 [FIRST_FLOOR_PAUSE_POSITION] Step 2/4: Raising Z to 2mm
  G90
  G1 Z2 F600
  M118 [FIRST_FLOOR_PAUSE_POSITION] Step 3/4: Moving to park X={x_park} Y={y_park}
  G1 X{x_park} Y{y_park} F6000
  M118 [FIRST_FLOOR_PAUSE_POSITION] Step 4/4: Lowering Z to 0.2mm
  G1 Z0.2 F600
  M118 ========================================
  M118 [FIRST_FLOOR_PAUSE_POSITION] MACRO END
  M118 ========================================

[gcode_macro ACCURATE_G28]
gcode:
  ACCURATE_HOME_Z

[gcode_macro START_PRINT]
variable_prepare: 0
gcode:
  M118 ========================================
  M118 [START_PRINT] Starting print sequence
  M118 ========================================
  BOX_START_PRINT
  G90
  WAIT_TEMP_END
  CLEAR_PAUSE
  {% set g28_extruder_temp = printer.custom_macro.g28_ext_temp %}
  {% set bed_temp = printer.custom_macro.default_bed_temp %}
  {% set extruder_temp = printer.custom_macro.default_extruder_temp %}
  {% if 'BED_TEMP' in params|upper and (params.BED_TEMP|float) %}
    {% set bed_temp = params.BED_TEMP %}
  {% endif %}
  {% if 'EXTRUDER_TEMP' in params|upper and (params.EXTRUDER_TEMP|float) %}
    {% set extruder_temp = params.EXTRUDER_TEMP %}
  {% endif %}
  M118 [START_PRINT] Target temps: Bed={bed_temp}C Extruder={extruder_temp}C
  {% if printer['gcode_macro START_PRINT'].prepare|int == 0 %}
    M118 [START_PRINT] Running full preparation sequence
    PRINT_PREPARE_CLEAR
    M118 [START_PRINT] Step 1: Setting temperatures
    M104 S{g28_extruder_temp}
    M140 S{bed_temp}
    M118 [START_PRINT] Step 2: Simple homing (no nozzle clear)
    SIMPLE_G28
    M118 [START_PRINT] Step 3: Bed leveling calibration
    CX_PRINT_LEVELING_CALIBRATION
  {% else %}
    M118 [START_PRINT] Skipping preparation (already prepared)
    PRINT_PREPARE_CLEAR
  {% endif %}
  M118 [START_PRINT] Print preparation complete
  M118 ========================================
[gcode_macro PRINT_PREPARED]
gcode:
  SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=prepare VALUE=1
  {action_respond_info("print prepared")}
[gcode_macro PRINT_PREPARE_CLEAR]
gcode:
  SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=prepare VALUE=0
[gcode_macro END_PRINT_POINT_WITHOUT_LIFTING]
gcode:
  M118 ========================================
  M118 [END_PRINT_POINT_WITHOUT_LIFTING] Moving to end position
  M118 ========================================
  {% if "xyz" in printer.toolhead.homed_axes %}
    {% set E = printer["gcode_macro PAUSE"].extrude|float %}
    {% set y_park = printer.toolhead.axis_maximum.y/2 %}
    {% set x_park = printer.toolhead.axis_maximum.x|float - 10.0 %}
    M118 [END_PRINT_POINT_WITHOUT_LIFTING] Step 1/4: Retracting filament
    G91
    {% if printer.extruder.can_extrude|lower == 'true' %}
      G1 E-1.0 F180
      G1 E-{E} F4000
    {% else %}
      M118 [END_PRINT_POINT_WITHOUT_LIFTING] WARNING: Extruder not hot enough
    {% endif %}
    M118 [END_PRINT_POINT_WITHOUT_LIFTING] Step 2/4: Raising Z by 2mm
    G1 Z2.0 F600
    G90
    M118 [END_PRINT_POINT_WITHOUT_LIFTING] Step 3/4: Moving to park position X={x_park} Y={y_park}
    G1 X{x_park} Y{y_park} F30000
    M118 [END_PRINT_POINT_WITHOUT_LIFTING] Step 4/4: At park position
  {% else %}
    M118 [END_PRINT_POINT_WITHOUT_LIFTING] ERROR: Printer not homed, cannot move
  {% endif %}
  M118 ========================================
  M118 [END_PRINT_POINT_WITHOUT_LIFTING] MACRO END
  M118 ========================================
[gcode_macro END_PRINT_POINT]
gcode:
  M118 ========================================
  M118 [END_PRINT_POINT] Moving to end position with Z lift
  M118 ========================================
  {% if "xyz" in printer.toolhead.homed_axes %}
    {% set E = printer["gcode_macro PAUSE"].extrude|float %}
    {% set max_z = printer["gcode_macro PRINTER_PARAM"].max_z_position|float %}
    {% set act_z = printer.toolhead.position.z|float %}
    {% set z_safe = 0.0 %}
    {% if act_z < (max_z / 2) %}
      {% set z_safe = (max_z / 2) - act_z %}
    {% elif act_z < max_z %}
      {% set z_safe = 2.0 %}
    {% endif %}
    {% set y_park = printer.toolhead.axis_maximum.y/2 %}
    {% set x_park = printer.toolhead.axis_maximum.x|float - 10.0 %}
    M118 [END_PRINT_POINT] Current Z={act_z}, calculated safe lift={z_safe}mm
    M118 [END_PRINT_POINT] Step 1/5: Retracting filament
    G91
    {% if printer.extruder.can_extrude|lower == 'true' %}
      G1 E-1.0 F180
      G1 E-{E} F4000
    {% else %}
      M118 [END_PRINT_POINT] WARNING: Extruder not hot enough
    {% endif %}
    M118 [END_PRINT_POINT] Step 2/5: Raising Z by 2mm
    G1 Z2.0 F600
    G90
    M118 [END_PRINT_POINT] Step 3/5: Moving to park position X={x_park} Y={y_park}
    G1 X{x_park} Y{y_park} F30000
    {% if z_safe > 2.0 %}
      M118 [END_PRINT_POINT] Step 4/5: Additional Z lift by {z_safe - 2.0}mm
      G91
      {% set z_safe = z_safe - 2.0 %}
      G1 Z{z_safe} F600
      G90
    {% else %}
      M118 [END_PRINT_POINT] Step 4/5: No additional Z lift needed
    {% endif %}
    M118 [END_PRINT_POINT] Step 5/5: At final position
  {% else %}
    M118 [END_PRINT_POINT] ERROR: Printer not homed, cannot move
  {% endif %}
  M118 ========================================
  M118 [END_PRINT_POINT] MACRO END
  M118 ========================================
[gcode_macro END_PRINT]
gcode:
  M118 ========================================
  M118 [END_PRINT] Print complete
  M118 ========================================
  M118 [END_PRINT] Step 1/2: Running end sequence
  END_PRINT_NO_M84
  M118 [END_PRINT] Step 2/2: Disabling motors
  M84
  M118 ========================================
  M118 [END_PRINT] MACRO END
  M118 ========================================
[gcode_macro END_PRINT_NO_M84]
gcode:
  M118 ========================================
  M118 [END_PRINT_NO_M84] Ending print (keeping motors enabled)
  M118 ========================================
  M118 [END_PRINT_NO_M84] Step 1/12: Box end
  BOX_END
  M118 [END_PRINT_NO_M84] Step 2/12: Box end print
  BOX_END_PRINT
  M118 [END_PRINT_NO_M84] Step 3/12: Exiting Qmode
  Qmode_exit
  M118 [END_PRINT_NO_M84] Step 4/12: Resetting exclude object
  EXCLUDE_OBJECT_RESET
  M118 [END_PRINT_NO_M84] Step 5/12: Clearing print prepare flag
  PRINT_PREPARE_CLEAR
  M118 [END_PRINT_NO_M84] Step 6/12: Resetting speed to 100%
  M220 S100
  M118 [END_PRINT_NO_M84] Step 7/12: Resetting acceleration
  SET_VELOCITY_LIMIT ACCEL=5000 ACCEL_TO_DECEL=2500
  M118 [END_PRINT_NO_M84] Step 8/12: Turning off heaters
  TURN_OFF_HEATERS
  M118 [END_PRINT_NO_M84] Step 9/12: Turning off chamber and auxiliary fans only
  M107 P1
  M118 [END_PRINT_NO_M84] Step 10/12: Moving to end position
  END_PRINT_POINT
  M118 [END_PRINT_NO_M84] Step 11/12: Starting filament-specific post-print cooling
  {% set cooling = printer['gcode_macro PRINTER_PARAM'].post_cool_level|int %}
  M118 [END_PRINT_NO_M84] Cooling level: {cooling}%
  {% if cooling == 0 %}
    POST_COOL_NONE
  {% elif cooling == 25 %}
    POST_COOL_25
  {% elif cooling == 50 %}
    POST_COOL_50
  {% elif cooling == 75 %}
    POST_COOL_75
  {% elif cooling == 100 %}
    POST_COOL_100
  {% else %}
    M118 [END_PRINT_NO_M84] WARNING: Unknown cooling level {cooling}, using 25% default
    POST_COOL_25
  {% endif %}
  M118 [END_PRINT_NO_M84] Step 12/12: Complete
#  BOX_GET_FIVE_WAY_STATE
  M118 ========================================
  M118 [END_PRINT_NO_M84] MACRO END
  M118 ========================================
[gcode_macro FIRST_FLOOR_PAUSE]
description: Pause the first floor print
# change this if you need more or less extrusion
variable_extrude: 2.0
gcode:
  M118 ========================================
  M118 [FIRST_FLOOR_PAUSE] Pausing first floor print
  M118 ========================================
  ##### read E from pause macro #####
  {% set E = printer["gcode_macro FIRST_FLOOR_PAUSE"].extrude|float %}
  ##### set park positon for x and y #####
  # default is your max posion from your printer.cfg
  {% set y_park = printer.toolhead.axis_maximum.y/2 %}
  {% set x_park = printer.toolhead.axis_maximum.x|float - 10.0 %}
  ##### calculate save lift position #####
  {% set max_z = printer["gcode_macro PRINTER_PARAM"].max_z_position|float %}
  {% set act_z = printer.toolhead.position.z|float %}
  {% set z_safe = 0.0 %}
  {% if act_z < (max_z - 2.0) %}
    {% set z_safe = 2.0 %}
  {% elif act_z < max_z %}
    {% set z_safe = max_z - act_z %}
  {% endif %}
  M118 [FIRST_FLOOR_PAUSE] Current Z={act_z}, safe lift={z_safe}mm, park X={x_park} Y={y_park}
  ##### end of definitions #####
  M118 [FIRST_FLOOR_PAUSE] Step 1/6: Saving safe Z position
  SET_GCODE_VARIABLE MACRO=PRINTER_PARAM VARIABLE=z_safe_pause VALUE={z_safe|float}
  M118 [FIRST_FLOOR_PAUSE] Step 2/6: Calling PAUSE_BASE
  PAUSE_BASE
  G91
  {% if "xyz" in printer.toolhead.homed_axes %}
    M118 [FIRST_FLOOR_PAUSE] Step 3/6: Retracting filament
    {% if printer.extruder.can_extrude|lower == 'true' %}
      G1 E-1.0 F180
      G1 E-{E} F4000
    {% else %}
      M118 [FIRST_FLOOR_PAUSE] WARNING: Extruder not hot enough
    {% endif %}
    M118 [FIRST_FLOOR_PAUSE] Step 4/6: Moving to park position
    G1 Z{z_safe} F600
    G90
    G1 X{x_park} Y{y_park} F30000
  {% else %}
    M118 [FIRST_FLOOR_PAUSE] ERROR: Printer not homed
  {% endif %}
  M118 [FIRST_FLOOR_PAUSE] Step 5/6: Saving fan2 state and turning off
  # save fan2 value and turn off fan2
  SET_GCODE_VARIABLE MACRO=PRINTER_PARAM VARIABLE=fan2_speed VALUE={printer['output_pin fan2'].value}
  {% set fspeed = printer['gcode_macro PRINTER_PARAM'].fan2_speed %}
  M118 [FIRST_FLOOR_PAUSE] Fan2 value saved: {fspeed}
  # SET_PIN PIN=fan2 VALUE=0
  M106 P2 S0
  M118 [FIRST_FLOOR_PAUSE] Step 6/6: Setting minimum extruder current
  SET_E_MIN_CURRENT
  M118 ========================================
  M118 [FIRST_FLOOR_PAUSE] MACRO END
  M118 ========================================
[gcode_macro FIRST_FLOOR_RESUME]
description: Resume the first floor print
gcode:
  M118 ========================================
  M118 [FIRST_FLOOR_RESUME] Resuming first floor print
  M118 ========================================
  M118 [FIRST_FLOOR_RESUME] Step 1/5: Restoring extruder current
  RESTORE_E_CURRENT
  {% if printer['gcode_macro PRINTER_PARAM'].fan2_speed > 0 %}
    M118 [FIRST_FLOOR_RESUME] Step 2/5: Restoring fan2 speed
    {% set s_value = (printer['gcode_macro PRINTER_PARAM'].fan2_speed * 255 - printer['gcode_macro PRINTER_PARAM'].fan2_min) * 255 / (255 - printer['gcode_macro PRINTER_PARAM'].fan2_min)|float %}
    M118 [FIRST_FLOOR_RESUME] Fan2 restored to S={s_value}
    M106 P2 S{s_value}
  {% else %}
    M118 [FIRST_FLOOR_RESUME] Step 2/5: No fan2 speed to restore
  {% endif %}
  ##### read E from pause macro #####
  {% set E = printer["gcode_macro FIRST_FLOOR_PAUSE"].extrude|float + 1.0 %}
  #### get VELOCITY parameter if specified ####
  {% if 'VELOCITY' in params|upper %}
    {% set get_params = ('VELOCITY=' + params.VELOCITY) %}
  {%else %}
    {% set get_params = "" %}
  {% endif %}
  ##### end of definitions #####
  M118 [FIRST_FLOOR_RESUME] Step 3/5: Priming extruder ({E}mm)
  {% if printer.extruder.can_extrude|lower == 'true' %}
    G91
    G1 E{E} F2100
  {% else %}
    M118 [FIRST_FLOOR_RESUME] WARNING: Extruder not hot enough
  {% endif %}
  M118 [FIRST_FLOOR_RESUME] Step 4/5: Waiting for moves to complete
  M400
  M118 [FIRST_FLOOR_RESUME] Step 5/5: Calling RESUME_BASE
  RESUME_BASE {get_params}
  M118 ========================================
  M118 [FIRST_FLOOR_RESUME] MACRO END
  M118 ========================================
[gcode_macro WAIT_PAUSE]
# change this if you need more or less extrusion
variable_extrude: 2.0
gcode:
  M118 ========================================
  M118 [WAIT_PAUSE] Pausing and waiting
  M118 ========================================
  ##### read E from pause macro #####
  {% set E = printer["gcode_macro WAIT_PAUSE"].extrude|float %}
  ##### set park positon for x and y #####
  # default is your max posion from your printer.cfg
  {% set y_park = printer.toolhead.axis_maximum.y/2 %}
  {% set x_park = printer.toolhead.axis_maximum.x|float - 10.0 %}
  ##### calculate save lift position #####
  {% set max_z = printer["gcode_macro PRINTER_PARAM"].max_z_position|float %}
  {% set act_z = printer.toolhead.position.z|float %}
  {% set z_safe = 0.0 %}
  {% if act_z < 48.0 %}
    {% set z_safe = 50.0 - act_z %}
  {% elif act_z < (max_z - 2.0) %}
    {% set z_safe = 2.0 %}
  {% elif act_z < max_z %}
    {% set z_safe = max_z - act_z %}
  {% endif %}
  M118 [WAIT_PAUSE] Current Z={act_z}, safe lift={z_safe}mm
  ##### end of definitions #####
  M118 [WAIT_PAUSE] Step 1/6: Saving safe Z and hotend temp
  SET_GCODE_VARIABLE MACRO=PRINTER_PARAM VARIABLE=z_safe_pause VALUE={z_safe|float}
  SET_GCODE_VARIABLE MACRO=PRINTER_PARAM VARIABLE=hotend_temp VALUE={printer.extruder.target}
  M118 [WAIT_PAUSE] Step 2/6: Setting hotend to 140C
  # PAUSE_BASE
  G91
  M104 S140
  {% if "xyz" in printer.toolhead.homed_axes %}
    M118 [WAIT_PAUSE] Step 3/6: Retracting filament
    {% if printer.extruder.can_extrude|lower == 'true' %}
      G1 E-1.0 F180
      G1 E-{E} F4000
    {% else %}
      M118 [WAIT_PAUSE] WARNING: Extruder not hot enough
    {% endif %}
    M118 [WAIT_PAUSE] Step 4/6: Moving to park position X={x_park} Y={y_park}
    G1 Z{z_safe} F600
    M400
    G90
    G1 X{x_park} Y{y_park} F30000
  {% else %}
    M118 [WAIT_PAUSE] ERROR: Printer not homed
  {% endif %}
  M118 [WAIT_PAUSE] Step 5/6: Saving fan2 state and turning off
  # save fan2 value and turn off fan2
  SET_GCODE_VARIABLE MACRO=PRINTER_PARAM VARIABLE=fan2_speed VALUE={printer['output_pin fan2'].value}
  {% set fspeed = printer['gcode_macro PRINTER_PARAM'].fan2_speed %}
  M118 [WAIT_PAUSE] Fan2 value saved: {fspeed}
  # SET_PIN PIN=fan2 VALUE=0
  M106 P2 S0
  M118 [WAIT_PAUSE] Step 6/6: Setting minimum extruder current
  SET_E_MIN_CURRENT
  M118 ========================================
  M118 [WAIT_PAUSE] MACRO END
  M118 ======================================== 
[gcode_macro PAUSE]
description: Pause the actual running print
rename_existing: PAUSE_BASE
# change this if you need more or less extrusion
variable_extrude: 2.0
gcode:
  M118 ========================================
  M118 [PAUSE] Pausing print
  M118 ========================================
  {% if printer.pause_resume.is_paused|lower == 'false' %}
    M118 [PAUSE] Step 1/3: Calling PAUSE_BASE
    ##### read E from pause macro #####
    # {% set E = printer["gcode_macro PAUSE"].extrude|float %}
    # ##### set park positon for x and y #####
    # # default is your max posion from your printer.cfg
    # {% set y_park = printer.toolhead.axis_maximum.y/2 %}
    # {% set x_park = printer.toolhead.axis_maximum.x|float - 10.0 %}
    # ##### calculate save lift position #####
    # {% set max_z = printer["gcode_macro PRINTER_PARAM"].max_z_position|float %}
    # {% set act_z = printer.toolhead.position.z|float %}
    # {% set z_safe = 0.0 %}
    # {% if act_z < 48.0 %}
    #   {% set z_safe = 50.0 - act_z %}
    # {% elif act_z < (max_z - 2.0) %}
    #   {% set z_safe = 2.0 %}
    # {% elif act_z < max_z %}
    #   {% set z_safe = max_z - act_z %}
    # {% endif %}
    # {action_respond_info("z_safe = %s"% (z_safe))}
    # ##### end of definitions #####
    # SET_GCODE_VARIABLE MACRO=PRINTER_PARAM VARIABLE=z_safe_pause VALUE={z_safe|float}
    PAUSE_BASE
    {% if params.POST_WORK|default(1)|int == 1 %}
    M118 [PAUSE] Step 2/3: Running post-pause work
    DO_AFTER_PAUSE
    {% else %}
    M118 [PAUSE] Step 2/3: Skipping post-pause work (POST_WORK=0)
    {% endif %}
    M118 [PAUSE] Step 3/3: Pause complete
    # G91
    # SET_GCODE_VARIABLE MACRO=PRINTER_PARAM VARIABLE=hotend_temp VALUE={printer.extruder.target}
    # M104 S140
    # {% if "xyz" in printer.toolhead.homed_axes %}
    #   {% if printer.extruder.can_extrude|lower == 'true' %}
    #     G1 E-1.0 F180
    #     G1 E-{E} F4000
    #   {% else %}
    #     {action_respond_info("Extruder not hot enough")}
    #   {% endif %}
    #   G1 Z{z_safe} F600
    #   M400
    #   G90
    #   G1 X{x_park} Y{y_park} F30000
    # {% else %}
    #   {action_respond_info("Printer not homed")}
    # {% endif %}
    # # save fan2 value and turn off fan2
    # SET_GCODE_VARIABLE MACRO=PRINTER_PARAM VARIABLE=fan2_speed VALUE={printer['output_pin fan2'].value}
    # {% set fspeed = printer['gcode_macro PRINTER_PARAM'].fan2_speed %}
    # {action_respond_info("fan2_value = %s \n" % (fspeed))}
    # # SET_PIN PIN=fan2 VALUE=0
    # M106 P2 S0
    # SET_E_MIN_CURRENT
  {% else %}
    M118 [PAUSE] Already paused, ignoring
  {% endif %}
  M118 ========================================
  M118 [PAUSE] MACRO END
  M118 ========================================
[gcode_macro INPUTSHAPER]
gcode:
  M118 ========================================
  M118 [INPUTSHAPER] Starting input shaper calibration
  M118 ========================================
  M118 [INPUTSHAPER] Step 1/8: Disabling filament sensors
  SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=0
  SET_FILAMENT_SENSOR SENSOR=filament_sensor_2 ENABLE=0
  M118 [INPUTSHAPER] Step 2/8: Homing all axes
  G90
  G28
  {% set POSITION_X = printer.configfile.settings['stepper_x'].position_max/2 %}
  {% set POSITION_Y = printer.configfile.settings['stepper_y'].position_max/2 %}
  M118 [INPUTSHAPER] Step 3/8: Moving to center X={POSITION_X} Y={POSITION_Y}
  G1 X{POSITION_X} Y{POSITION_Y} F6000
  M118 [INPUTSHAPER] Step 4/8: Raising Z to 10mm
  G1 Z10 F600
  M118 [INPUTSHAPER] Step 5/8: Running Y-axis shaper calibration
  SHAPER_CALIBRATE AXIS=y
  M118 [INPUTSHAPER] Step 6/8: Saving config
  CXSAVE_CONFIG
  M118 [INPUTSHAPER] Step 7/8: Re-enabling filament sensors
  SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=1
  SET_FILAMENT_SENSOR SENSOR=filament_sensor_2 ENABLE=1
  M118 [INPUTSHAPER] Step 8/8: Calibration complete
  M118 ========================================
  M118 [INPUTSHAPER] MACRO END
  M118 ========================================
[gcode_macro BEDPID]
gcode:
  M118 ========================================
  M118 [BEDPID] Starting bed PID calibration
  M118 ========================================
  M118 [BEDPID] Step 1/2: Running PID calibration at 100C
  PID_CALIBRATE HEATER=heater_bed TARGET=100
  M118 [BEDPID] Step 2/2: Saving config
  SAVE_CONFIG
  M118 ========================================
  M118 [BEDPID] MACRO END
  M118 ========================================
[gcode_macro TUNOFFINPUTSHAPER]
gcode:
  M118 ========================================
  M118 [TUNOFFINPUTSHAPER] Turning off input shaper
  M118 ========================================
  M118 [TUNOFFINPUTSHAPER] Setting shaper frequencies to 0
  SET_INPUT_SHAPER SHAPER_FREQ_X=0 SHAPER_FREQ_Y=0
  M118 ========================================
  M118 [TUNOFFINPUTSHAPER] MACRO END
  M118 ========================================
[gcode_macro RESUME]
description: Resume the actual running print
rename_existing: RESUME_BASE
gcode:
  M118 ========================================
  M118 [RESUME] Resuming print
  M118 ========================================
  M118 [RESUME] Step 1/8: Clearing box errors
  BOX_ERROR_CLEAR
  M118 [RESUME] Step 2/8: Restoring extruder current
  RESTORE_E_CURRENT
  M118 [RESUME] Step 3/8: Resuming box extrude
  BOX_RESUME_EXTRUDE
  M118 [RESUME] Step 4/8: Restoring hotend temperature
  {% if printer['gcode_macro PRINTER_PARAM'].hotend_temp|int != 0 %}
    {% if printer['gcode_macro PRINTER_PARAM'].hotend_temp|int > printer.extruder.temperature %}
      M118 [RESUME] Heating to {printer['gcode_macro PRINTER_PARAM'].hotend_temp}C
      M109 S{printer['gcode_macro PRINTER_PARAM'].hotend_temp|int}
    {% else %}
      M118 [RESUME] Setting temp to {printer['gcode_macro PRINTER_PARAM'].hotend_temp}C
      M104 S{printer['gcode_macro PRINTER_PARAM'].hotend_temp|int}
    {% endif %}
    SET_GCODE_VARIABLE MACRO=PRINTER_PARAM VARIABLE=hotend_temp VALUE=0
  {% else %}
    M118 [RESUME] No temperature restore needed
  {% endif %}
  M118 [RESUME] Step 5/8: Restoring fan2 speed
  {% if printer['gcode_macro PRINTER_PARAM'].fan2_speed > 0 %}
    {% set s_value = (printer['gcode_macro PRINTER_PARAM'].fan2_speed * 255 - printer['gcode_macro PRINTER_PARAM'].fan2_min) * 255 / (255 - printer['gcode_macro PRINTER_PARAM'].fan2_min)|float %}
    M118 [RESUME] Restoring fan2 speed
    M106 P2 S{s_value}
  {% else %}
    M118 [RESUME] No fan2 restore needed
  {% endif %}
  M118 [RESUME] Step 6/8: Moving Y to safe position
  {% set safe_pos_y = printer.configfile.settings['box'].safe_pos_y %}
  {% set cur_y = printer.toolhead.position.y|float %}
  M118 [RESUME] Current Y={cur_y}, Safe Y={safe_pos_y}
  {% if cur_y > safe_pos_y %}
    M118 [RESUME] Moving to safe Y position
    G0 Y{safe_pos_y}
    M400
  {% else %}
    M118 [RESUME] Already at safe Y position
  {% endif %}
  M118 [RESUME] Step 7/8: Lowering Z to resume height
  {% set z_resume_move = printer['gcode_macro PRINTER_PARAM'].z_safe_pause|int %}
  {% if z_resume_move > 2 %}
    {% set z_resume_move = z_resume_move - 2 %}
    M118 [RESUME] Lowering Z by {z_resume_move}mm
    G91
    G1 Z-{z_resume_move} F600
    M400
  {% else %}
    M118 [RESUME] No Z movement needed
  {% endif %}
  M118 [RESUME] Step 8/8: Priming extruder and resuming
  {% set E = printer["gcode_macro PAUSE"].extrude|float + 1.0 %}
  {% if 'VELOCITY' in params|upper %}
    {% set get_params = ('VELOCITY=' + params.VELOCITY) %}
  {%else %}
    {% set get_params = "" %}
  {% endif %}
  {% if printer.extruder.can_extrude|lower == 'true' and printer.box.enable|int != 1 %}
    M118 [RESUME] Priming {E}mm
    G91
    G1 E{E} F2100
    G90
  {% else %}
    M118 [RESUME] WARNING: Extruder not hot enough to prime
  {% endif %}
  M400
  M118 ========================================
  M118 [RESUME] MACRO END - Print resuming
  M118 ========================================
  RESUME_BASE {get_params}
[gcode_macro CANCEL_PRINT]
description: Cancel the actual running print
rename_existing: CANCEL_PRINT_BASE
gcode:
  M118 ========================================
  M118 [CANCEL_PRINT] Canceling print
  M118 ========================================
  M118 [CANCEL_PRINT] Step 1/2: Running end print sequence
  END_PRINT_NO_M84
  M118 [CANCEL_PRINT] Step 2/2: Canceling print job
  CANCEL_PRINT_BASE
  M118 ========================================
  M118 [CANCEL_PRINT] MACRO END
  M118 ========================================
[gcode_macro G29]
gcode:
  M118 ========================================
  M118 [G29] Starting bed mesh leveling
  M118 ========================================
  {% if 'PROBE_COUNT' in params|upper %}
    {% set get_count = ('PROBE_COUNT' + params.PROBE_COUNT) %}
  {%else %}
    {% set get_count = "" %}
  {% endif %}
  {% set bed_temp = printer.custom_macro.default_bed_temp %}
  {% set extruder_temp = printer.custom_macro.g28_ext_temp %}
  {% set nozzle_clear_temp = printer.custom_macro.default_extruder_temp %}
  {% if 'BED_TEMP' in params|upper %}
    {% set bed_temp = params.BED_TEMP %}
  {% endif %}
  {% if 'EXTRUDER_TEMP' in params|upper %}
    {% set nozzle_clear_temp = params.EXTRUDER_TEMP %}
  {% endif %}
  M118 [G29] Bed={bed_temp}C, Extruder min={extruder_temp}C, max={nozzle_clear_temp}C
  M118 [G29] Step 1/12: Disabling filament sensors
  SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=0
  SET_FILAMENT_SENSOR SENSOR=filament_sensor_2 ENABLE=0
  M118 [G29] Step 2/12: Homing all axes
  G28
  M118 [G29] Step 3/12: Clearing existing bed mesh
  BED_MESH_CLEAR
  M118 [G29] Step 4/12: Clearing nozzle
  NOZZLE_CLEAR HOT_MIN_TEMP={extruder_temp} HOT_MAX_TEMP={nozzle_clear_temp} BED_MAX_TEMP={bed_temp}
  M118 [G29] Step 5/12: Re-homing Z axis
  G28 Z
  M118 [G29] Step 6/12: Setting acceleration
  M204 S5000
  SET_VELOCITY_LIMIT ACCEL_TO_DECEL=5000
  M118 [G29] Step 7/12: Running bed mesh calibration
  BED_MESH_CALIBRATE {get_count}
  M118 [G29] Step 8/12: Outputting bed mesh
  BED_MESH_OUTPUT
  {% set y_park = printer.toolhead.axis_maximum.y/2 %}
  {% set x_park = printer.toolhead.axis_maximum.x|float - 10.0 %}
  M118 [G29] Step 9/12: Moving to park position X={x_park} Y={y_park}
  G1 X{x_park} Y{y_park} F2000
  M118 [G29] Step 10/12: Saving config
  CXSAVE_CONFIG
  M118 [G29] Step 11/12: Turning off heaters
  TURN_OFF_HEATERS
  M118 [G29] Step 12/12: Re-enabling filament sensors
  SET_FILAMENT_SENSOR SENSOR=filament_sensor ENABLE=1
  SET_FILAMENT_SENSOR SENSOR=filament_sensor_2 ENABLE=1
  M118 ========================================
  M118 [G29] MACRO END
  M118 ========================================
[gcode_macro G299]
gcode:
    M118 ========================================
    M118 [G299] Starting PRTouch bed mesh calibration
    M118 ========================================
    M118 [G299] Step 1/5: Clearing existing bed mesh
    BED_MESH_CLEAR
    M118 [G299] Step 2/5: Homing all axes
    G28
    M118 [G299] Step 3/5: Preparing PRTouch
    PRTOUCH_READY
    M118 [G299] Step 4/5: Running bed mesh calibration
    BED_MESH_CALIBRATE
    M118 [G299] Step 5/5: Outputting bed mesh
    BED_MESH_OUTPUT
    M118 ========================================
    M118 [G299] MACRO END
    M118 ========================================
[gcode_macro IF_NEED_HOME]
gcode:
  M118 [IF_NEED_HOME] Checking if printer is homed
  {% set x_axes = printer.toolhead.homed_axes %}
  {% if x_axes is defined and x_axes[0] is defined %}
    M118 [IF_NEED_HOME] Printer already homed: {x_axes}
  {% else %}
    M118 [IF_NEED_HOME] Printer not homed - starting G28
    G28
    M118 [IF_NEED_HOME] Homing complete
  {% endif %}
[gcode_macro BOX_TEST_CLEAN]
gcode:
    M118 ========================================
    M118 [BOX_TEST_CLEAN] Starting nozzle cleaning test
    M118 ========================================
    M118 [BOX_TEST_CLEAN] Step 1/11: Homing if needed
    IF_NEED_HOME
    M118 [BOX_TEST_CLEAN] Step 2/11: Raising Z to 100mm
    G0 Z100 F5000
    M118 [BOX_TEST_CLEAN] Step 3/11: Heating nozzle to 220C
    M104 S220
    M109 S220
    {% set count = 1 %}
    {% for i in range(count) %}
    M118 [BOX_TEST_CLEAN] Step 4/11: Moving to extrude position
    G90
    G0 X164 F5000
    M400
    G0 Y226.5 F5000
    M400
    M118 [BOX_TEST_CLEAN] Step 5/11: Extruding 40mm material
    M83
    G1 E40 F300
    M400
    M118 [BOX_TEST_CLEAN] Step 6/11: Retracting 5mm
    G1 E-5 F600
    M400
    M118 [BOX_TEST_CLEAN] Step 7/11: Running fan for cooling (4s on, 3s off)
    SET_PIN PIN=fan0 VALUE=128
    G4 P4000
    SET_PIN PIN=fan0 VALUE=0
    G4 P3000
    M400
    M118 [BOX_TEST_CLEAN] Step 8/11: Starting wipe sequence (2 passes)
    SET_VELOCITY_LIMIT ACCEL=5000 ACCEL_TO_DECEL=30000
    G90
    {% for _ in range(2) %}
    G0 X139 Y226 F2500
    G0 X164 Y226 F2500
    {% endfor %}
    M118 [BOX_TEST_CLEAN] Step 9/11: Final wipe position
    G0 X131 Y226 F2500
    M400
    M118 [BOX_TEST_CLEAN] Step 10/11: Returning to safe Y position
    G90
    G0 Y130 F6000
    M400
    M118 [BOX_TEST_CLEAN] Step 11/11: Returning to safe X position
    G0 X164 F6000
    M400
    {% endfor %}
    M118 ========================================
    M118 [BOX_TEST_CLEAN] MACRO END
    M118 ========================================
[gcode_macro BOX_TEST_CUT_MATERIAL_SCRIPT]
gcode:
    M118 ========================================
    M118 [BOX_TEST_CUT_MATERIAL_SCRIPT] Starting cut test
    M118 ========================================
    {% set count = 1 %}
    {% for i in range(count) %}
    M118 [BOX_TEST_CUT_MATERIAL_SCRIPT] Step 1/8: Homing if needed
    IF_NEED_HOME
    M118 [BOX_TEST_CUT_MATERIAL_SCRIPT] Step 2/8: Raising Z to 100mm
    G0 Z100 F5000
    M118 [BOX_TEST_CUT_MATERIAL_SCRIPT] Step 3/8: Heating nozzle to 220C
    M104 S220
    M109 S220
    M118 [BOX_TEST_CUT_MATERIAL_SCRIPT] Step 4/8: Moving to blade position
    G90
    G0 Y180 F12000
    G0 X46 F12000
    M118 [BOX_TEST_CUT_MATERIAL_SCRIPT] Step 5/8: Extruding 40mm material
    M83
    G1 E40 F300
    M400
    M118 [BOX_TEST_CUT_MATERIAL_SCRIPT] Step 6/8: Setting velocity limits
    SET_VELOCITY_LIMIT ACCEL=5000 ACCEL_TO_DECEL=30000
    M118 [BOX_TEST_CUT_MATERIAL_SCRIPT] Step 7/8: Performing 3 cut passes
    {% for _ in range(3) %}
    G0 X46 Y227.2 F12000
    G0 X46 Y180 F12000
    {% endfor %}
    M400
    M118 [BOX_TEST_CUT_MATERIAL_SCRIPT] Step 8/8: Cut test complete
    {% endfor %}
    M118 ========================================
    M118 [BOX_TEST_CUT_MATERIAL_SCRIPT] MACRO END
    M118 ========================================
;    #{action_respond_info(i.__str__()) }
[gcode_macro BOX_TEST_CUT_AND_CLEAN]
gcode:
    M118 ========================================
    M118 [BOX_TEST_CUT_AND_CLEAN] Starting combined cut and clean test
    M118 ========================================
    {% set count = 1 %}
    {% for i in range(count) %}
    M118 [BOX_TEST_CUT_AND_CLEAN] Step 1/3: Running cut material test
    BOX_TEST_CUT_MATERIAL_SCRIPT
    M118 [BOX_TEST_CUT_AND_CLEAN] Step 2/3: Running clean test
    BOX_TEST_CLEAN
    M118 [BOX_TEST_CUT_AND_CLEAN] Step 3/3: Waiting for moves to complete
    M400
    {% endfor %}
    M118 ========================================
    M118 [BOX_TEST_CUT_AND_CLEAN] MACRO END
    M118 ========================================
;    #{action_respond_info(i.__str__()) }
[gcode_macro BOX_TEST_TNNX]
gcode:
    M118 ========================================
    M118 [BOX_TEST_TNNX] Starting tool change test (T0-T3)
    M118 ========================================
    {% set count = 4 %}
    {% for i in range(count) %}
    M118 [BOX_TEST_TNNX] Step {i+1}/4: Loading tool T{i%4}
    T{i%4}
    M400
    {% endfor %}
    M118 ========================================
    M118 [BOX_TEST_TNNX] MACRO END
    M118 ========================================
;    #{action_respond_info(i.__str__()) }
[gcode_macro EXTRUDE_TEST]
gcode:
  M118 ========================================
  M118 [EXTRUDE_TEST] Starting extrusion test
  M118 ========================================
  {% set times = params.TIMES|default(1)|int %}
  M118 [EXTRUDE_TEST] Test iterations: {times}
  M118 [EXTRUDE_TEST] Step 1/{7*times+1}: Setting hotend temp to 220C
  M104 S220
  {% for loop_idx in range(times) %}
    M118 [EXTRUDE_TEST] === Iteration {loop_idx+1}/{times} ===
    M118 [EXTRUDE_TEST] Step {loop_idx*7+2}/{7*times+1}: Moving to cut position
    BOX_MOVE_TO_CUT
    M118 [EXTRUDE_TEST] Step {loop_idx*7+3}/{7*times+1}: Moving to extrude position
    BOX_GO_TO_EXTRUDE_POS
    M118 [EXTRUDE_TEST] Step {loop_idx*7+4}/{7*times+1}: Extruding 100mm
    G91
    G0 E100 F360
    G90
    M400
    M118 [EXTRUDE_TEST] Step {loop_idx*7+5}/{7*times+1}: Cooling with fan (4 seconds)
    SET_PIN PIN=fan0 VALUE=255
    G4 P4000
    SET_PIN PIN=fan0 VALUE=0
    M400
    M118 [EXTRUDE_TEST] Step {loop_idx*7+6}/{7*times+1}: Cleaning nozzle
    BOX_NOZZLE_CLEAN
    M118 [EXTRUDE_TEST] Step {loop_idx*7+7}/{7*times+1}: Iteration {loop_idx+1} complete
  {% endfor %}
  M118 ========================================
  M118 [EXTRUDE_TEST] MACRO END
  M118 ========================================
[gcode_macro SAFE_WIPE_V2]
description: Wipe with correct kinematics and safe exit
gcode:
    M118 === SAFE_WIPE_V2 START ===
    # Home if needed
    IF_NEED_HOME
    {% set current_z = printer.toolhead.position.z %}
    {% set current_x = printer.toolhead.position.x %}
    {% set current_y = printer.toolhead.position.y %}
    {% set CLEARANCE = 10 %}
    {% set MIN_SAFE_Z = 30 %}
    {% set MAX_Z = 250 %}
    {% set WIPES = params.WIPES|default(4)|int %}
    M118 Current position: X={current_x} Y={current_y} Z={current_z}
    # Calculate target Z: max of (current+clearance, minimum safe)
    {% set target_z = [current_z + CLEARANCE, MIN_SAFE_Z]|max %}
    {% if target_z <= MAX_Z %}
        M118 Lowering bed to Z={target_z} (safe clearance)
        G90
        G0 Z{target_z} F6000
        M400
    {% else %}
        M118 WARNING: Z={target_z} exceeds max Z={MAX_Z}
        M118 Using maximum available Z={MAX_Z}
        G90
        G0 Z{MAX_Z} F6000
        M400
    {% endif %}
    # Move to wiper position (toolhead goes to back)
    M118 Moving toolhead to wiper: X=167 Y=226
    G90
    G0 X167 Y226 F5000
    M400
    M118 At wiper position
    # Perform wipes
    M118 Starting {WIPES} wipes
    {% for _ in range(WIPES) %}
        G0 X163.5 F3000
        G0 X174.5 F3000
    {% endfor %}
    M400
    M118 Wipes complete
    # Exit to safe position
    M118 Returning to safe position
    BOX_MOVE_TO_SAFE_POS
    M400
    M118 === SAFE_WIPE_V2 COMPLETE ===
[gcode_macro CUSTOM_PURGE_LINE]
description: Adaptive purge line that positions itself away from print objects
gcode:
    M118 ========================================
    M118 [PURGE_LINE] Starting adaptive purge line
    M118 ========================================

    # Proven settings from original macro
    {% set purge_height = 0.8 %}
    {% set tip_distance = 3 %}
    {% set purge_amount = 50 %}
    {% set flow_rate = 12 %}
    {% set travel_speed = (printer.toolhead.max_velocity * 60) | float %}
    {% set purge_move_speed = (flow_rate / 5.0) * 60 | float %}
    {% set rapid_move = 10 %}
    {% set purge_margin = 10 %}
    {% set z_hop = 5 %}

    # Bed dimensions
    {% set bed_x_max = 220 %}
    {% set bed_y_max = 220 %}

    # Try to get print object boundaries from exclude_object
    {% set all_points = printer.exclude_object.objects | map(attribute='polygon') | sum(start=[]) %}
    {% set purge_x_min = (all_points | map(attribute=0) | min | default(0)) %}
    {% set purge_x_max = (all_points | map(attribute=0) | max | default(0)) %}
    {% set purge_y_min = (all_points | map(attribute=1) | min | default(0)) %}
    {% set purge_y_max = (all_points | map(attribute=1) | max | default(0)) %}
    {% set object_detected = purge_x_min + purge_x_max + purge_y_min + purge_y_max %}

    # Calculate purge line center positions
    {% set purge_x_center = ([((purge_x_max + purge_x_min) / 2) - (purge_amount / 2), 0] | max) %}
    {% set purge_y_center = ([((purge_y_max + purge_y_min) / 2) - (purge_amount / 2), 0] | max) %}

    # Adjust if purge would go off bed
    {% if (purge_x_center + purge_amount + rapid_move) > bed_x_max %}
        {% set purge_x_center = (bed_x_max - (purge_amount + rapid_move)) %}
    {% endif %}
    {% if (purge_y_center + purge_amount + rapid_move) > bed_y_max %}
        {% set purge_y_center = (bed_y_max - (purge_amount + rapid_move)) %}
    {% endif %}

    # Calculate purge positions with margin
    {% set purge_x_origin_low = (purge_x_min - purge_margin) %}
    {% set purge_x_origin_high = (purge_x_max + purge_margin) %}
    {% set purge_y_origin_low = (purge_y_min - purge_margin) %}
    {% set purge_y_origin_high = (purge_y_max + purge_margin) %}

    # Check if there's enough room for a purge line in each direction
    {% set can_purge_front = (purge_y_origin_low > 0 and purge_y_origin_low > purge_amount) %}
    {% set can_purge_left = (purge_x_origin_low > 0 and purge_y_origin_high + purge_amount < bed_y_max) %}
    {% set can_purge_back = (purge_y_origin_high + purge_amount < bed_y_max) %}
    {% set can_purge_right = (purge_x_origin_high + purge_amount < bed_x_max and purge_y_origin_high + purge_amount < bed_y_max) %}

    # Determine purge strategy and log it
    {% if object_detected == 0 %}
        M118 [PURGE_LINE] No objects detected - using fallback position
        M118 [PURGE_LINE] Position: Back of bed (X=10-{10 + purge_amount}, Y=215)
        {% set strategy = 'fallback' %}
    {% elif can_purge_front %}
        M118 [PURGE_LINE] Objects detected - using adaptive positioning
        M118 [PURGE_LINE] Strategy: FRONT purge (below print)
        M118 [PURGE_LINE] Position: X={purge_x_center}-{purge_x_center + purge_amount}, Y={purge_y_origin_low - purge_amount}
        {% set strategy = 'front' %}
    {% elif can_purge_left %}
        M118 [PURGE_LINE] Objects detected - using adaptive positioning
        M118 [PURGE_LINE] Strategy: LEFT purge (left of print)
        M118 [PURGE_LINE] Position: X={purge_x_origin_low}, Y={purge_y_origin_high}-{purge_y_origin_high + purge_amount}
        {% set strategy = 'left' %}
    {% elif can_purge_back %}
        M118 [PURGE_LINE] Objects detected - using adaptive positioning
        M118 [PURGE_LINE] Strategy: BACK purge (behind print)
        M118 [PURGE_LINE] Position: X={purge_x_center}-{purge_x_center + purge_amount}, Y={purge_y_origin_high}
        {% set strategy = 'back' %}
    {% elif can_purge_right %}
        M118 [PURGE_LINE] Objects detected - using adaptive positioning
        M118 [PURGE_LINE] Strategy: RIGHT purge (right of print)
        M118 [PURGE_LINE] Position: X={purge_x_origin_high}, Y={purge_y_origin_high}-{purge_y_origin_high + purge_amount}
        {% set strategy = 'right' %}
    {% else %}
        M118 [PURGE_LINE] No space around print - using fallback
        M118 [PURGE_LINE] Position: Back of bed (X=10-{10 + purge_amount}, Y=215)
        {% set strategy = 'fallback' %}
    {% endif %}

    M118 [PURGE_LINE] Settings: height={purge_height}mm, amount={purge_amount}mm, flow={flow_rate}mm3/s

    # Save only E position
    {% set saved_e = printer.gcode_move.gcode_position.e %}

    G92 E0
    G0 F{travel_speed}
    G90
    M83

    # Execute purge based on strategy
    {% if strategy == 'fallback' %}
        # Fallback: back of bed, safe from most prints
        G0 Z{z_hop}
        G0 X10 Y215
        G0 Z{purge_height}
        M118 [PURGE_LINE] Priming tip with {tip_distance}mm
        G1 E{tip_distance} F{purge_move_speed}
        M118 [PURGE_LINE] Drawing purge line
        G1 X{10 + purge_amount} E{purge_amount} F{purge_move_speed}
        G1 E-0.5 F2400
        G0 X{10 + purge_amount + rapid_move} F{travel_speed}

    {% elif strategy == 'front' %}
        # Front: horizontal line below print
        G0 Z{z_hop}
        G0 X{purge_x_center} Y{purge_y_origin_low - purge_amount}
        G0 Z{purge_height}
        M118 [PURGE_LINE] Priming tip with {tip_distance}mm
        G1 E{tip_distance} F{purge_move_speed}
        M118 [PURGE_LINE] Drawing purge line
        G1 X{purge_x_center + purge_amount} E{purge_amount} F{purge_move_speed}
        G1 E-0.5 F2400
        G0 X{purge_x_center + purge_amount + rapid_move} F{travel_speed}

    {% elif strategy == 'left' %}
        # Left: vertical line to left of print, starting behind object
        G0 Z{z_hop}
        G0 X{purge_x_origin_low} Y{purge_y_origin_high}
        G0 Z{purge_height}
        M118 [PURGE_LINE] Priming tip with {tip_distance}mm
        G1 E{tip_distance} F{purge_move_speed}
        M118 [PURGE_LINE] Drawing purge line
        G1 Y{purge_y_origin_high + purge_amount} E{purge_amount} F{purge_move_speed}
        G1 E-0.5 F2400
        G0 Y{purge_y_origin_high + purge_amount + rapid_move} F{travel_speed}

    {% elif strategy == 'back' %}
        # Back: horizontal line behind print
        G0 Z{z_hop}
        G0 X{purge_x_center} Y{purge_y_origin_high}
        G0 Z{purge_height}
        M118 [PURGE_LINE] Priming tip with {tip_distance}mm
        G1 E{tip_distance} F{purge_move_speed}
        M118 [PURGE_LINE] Drawing purge line
        G1 X{purge_x_center + purge_amount} E{purge_amount} F{purge_move_speed}
        G1 E-0.5 F2400
        G0 X{purge_x_center + purge_amount + rapid_move} F{travel_speed}

    {% elif strategy == 'right' %}
        # Right: vertical line to right of print, starting behind object
        G0 Z{z_hop}
        G0 X{purge_x_origin_high} Y{purge_y_origin_high}
        G0 Z{purge_height}
        M118 [PURGE_LINE] Priming tip with {tip_distance}mm
        G1 E{tip_distance} F{purge_move_speed}
        M118 [PURGE_LINE] Drawing purge line
        G1 Y{purge_y_origin_high + purge_amount} E{purge_amount} F{purge_move_speed}
        G1 E-0.5 F2400
        G0 Y{purge_y_origin_high + purge_amount + rapid_move} F{travel_speed}
    {% endif %}

    # Final cleanup
    G92 E{saved_e}
    M82
    G0 Z{z_hop} F{travel_speed}

    M118 ========================================
    M118 [PURGE_LINE] Purge complete - ready for print
    M118 ========================================

[gcode_macro SIMPLE_G28]
description: Home without PRTouch nozzle clearing
gcode:
    M118 [SIMPLE_G28] Starting simple homing without nozzle clear
    
    # Home X and Y first
    {% if 'x' not in printer.toolhead.homed_axes %}
        M118 [SIMPLE_G28] Homing X
        G28 X
    {% endif %}
    
    {% if 'y' not in printer.toolhead.homed_axes %}
        M118 [SIMPLE_G28] Homing Y
        G28 Y
    {% endif %}
    
    # For Z, just do basic homing without the extra nozzle clear
    {% if 'z' not in printer.toolhead.homed_axes %}
        M118 [SIMPLE_G28] Homing Z (no nozzle clear)
        # Move to center for Z homing
        G90
        G0 X110 Y110 F6000
        # Home Z axis only
        G28 Z
    {% endif %}
    
    M118 [SIMPLE_G28] Homing complete

[gcode_macro PAUSE_WIPE_RESUME]
description: Pause print, wipe nozzle buildup, auto resume
gcode:
    M118 === PAUSE_WIPE_RESUME START ===

    # Use Klipper's built-in PAUSE (handles state, retraction, etc.)
    PAUSE

    # Raise Z relatively for clearance
    M118 Raising Z by 10mm for clearance
    G91  # Relative positioning
    G0 Z10 F6000  # Raise 10mm relative
    G90  # Back to absolute
    M400

    # Move to wiper position
    M118 Moving to wiper position
    G0 X167 Y226 F5000
    M400

    # Perform wipes (6 passes)
    M118 Starting 6 wipes
    {% for _ in range(6) %}
        G0 X163.5 F3000
        G0 X174.5 F3000
    {% endfor %}
    M400
    M118 Wipes complete

    # Move to safe position near where we paused
    M118 Moving near pause position
    G0 X110 Y110 F5000
    M400

    # Lower Z back down (get close, RESUME will handle final positioning)
    M118 Lowering Z back by 9mm
    G91
    G0 Z-9 F6000
    G90
    M400

    # Use Klipper's built-in RESUME (handles returning to exact position, unretraction, etc.)
    M118 === PAUSE_WIPE_RESUME COMPLETE ===
    M118 Automatically resuming print
    RESUME

